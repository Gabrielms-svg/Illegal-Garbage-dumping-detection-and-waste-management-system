<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dump Surveillance AI - Authority Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #1a237e;
        --primary-dark: #0d153a;
        --primary-light: #534bae;
        --secondary-color: #ff9800;
        --secondary-dark: #ef6c00;
        --accent-color: #d32f2f;
        --light-bg: #f5f5f5;
        --dark-text: #333;
        --light-text: #666;
        --white: #ffffff;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        color: var(--dark-text);
        background-color: var(--light-bg);
        line-height: 1.6;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: "Poppins", sans-serif;
        font-weight: 600;
      }

      /* Navbar Styles */
      .navbar {
        background-color: var(--white);
        box-shadow: var(--shadow);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        color: var(--primary-color);
        font-size: 1.8rem;
      }

      .logo h1 {
        font-size: 1.5rem;
        color: var(--primary-dark);
      }

      .nav-links {
        display: flex;
        gap: 1.5rem;
        align-items: center;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--dark-text);
        font-weight: 500;
        transition: color 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-links a:hover {
        color: var(--primary-color);
      }

      .nav-links .sign-out {
        color: var(--accent-color);
      }

      .nav-links .sign-out:hover {
        color: #b71c1c;
      }

      .authority-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #e8eaf6;
        padding: 8px 15px;
        border-radius: 20px;
      }

      .authority-badge i {
        color: var(--primary-color);
      }

      /* Main Content */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .authority-welcome {
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--primary-light)
        );
        color: var(--white);
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        flex-grow: 1;
        margin-right: 1rem;
      }

      .authority-welcome h2 {
        margin-bottom: 0.5rem;
      }

      .stats-card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        min-width: 200px;
        text-align: center;
      }

      .stats-card .number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-color);
        line-height: 1;
        margin-bottom: 0.5rem;
      }

      .stats-card .label {
        color: var(--light-text);
        font-size: 0.9rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        transition: transform 0.3s;
      }

      .card:hover {
        transform: translateY(-3px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px solid #eee;
      }

      .card-header h3 {
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      /* Offences Table */
      .offences-container {
        max-height: 500px;
        overflow-y: auto;
      }

      .offences-table {
        width: 100%;
        border-collapse: collapse;
      }

      .offences-table th {
        background-color: #f5f5f5;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--primary-dark);
        position: sticky;
        top: 0;
        border-bottom: 2px solid #ddd;
      }

      .offences-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
      }

      .offences-table tr:hover {
        background-color: #f9f9f9;
      }

      .status-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .status-pending {
        background-color: #fff3e0;
        color: #ef6c00;
      }

      .status-investigating {
        background-color: #e3f2fd;
        color: #1565c0;
      }

      .status-resolved {
        background-color: #e8f5e9;
        color: #2e7d32;
      }

      .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn {
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 0.9rem;
      }

      .btn:hover {
        background-color: var(--primary-dark);
      }

      .btn-secondary {
        background-color: var(--secondary-color);
      }

      .btn-secondary:hover {
        background-color: var(--secondary-dark);
      }

      .btn-danger {
        background-color: var(--accent-color);
      }

      .btn-danger:hover {
        background-color: #b71c1c;
      }

      .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }

      .filters-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .filter-group select,
      .filter-group input {
        padding: 0.6rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: "Roboto", sans-serif;
      }

      .download-options {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #eee;
      }

      /* Live Cameras */
      .cameras-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .camera-card {
        border-radius: 6px;
        overflow: hidden;
        position: relative; /* creates stacking context */
        height: 200px;
        background-color: #000;
        z-index: 1; /* prevents overlay overlap */
      }

      .camera-feed {
        width: 100%;
        height: 100%;
        object-fit: cover; /* fills card correctly */
        display: block; /* removes inline-gap issues */
        background-color: #000;
      }

      {% comment %} .camera-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }  {% endcomment %}

      .camera-status {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-active {
        background-color: #4caf50;
      }

      .status-inactive {
        background-color: #f44336;
      }

      /* Map Container */
      .map-container {
        height: 300px;
        background-color: #e0e0e0;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
      }

      .map-placeholder {
        text-align: center;
        color: var(--light-text);
      }

      .map-placeholder i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .map-controls {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      /* Recent Dumps Grid */
      .dumps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .dump-item {
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        height: 150px;
      }

      .dump-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }

      .dump-item:hover img {
        transform: scale(1.05);
      }

      .dump-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem;
        font-size: 0.8rem;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 1.5rem;
        margin-top: 2rem;
        border-top: 1px solid #ddd;
        color: var(--light-text);
        font-size: 0.9rem;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .dashboard-header {
          flex-direction: column;
          gap: 1rem;
        }

        .authority-welcome {
          margin-right: 0;
          width: 100%;
        }

        .stats-card {
          width: 100%;
        }
      }

      @media (max-width: 768px) {
        .navbar {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-links {
          width: 100%;
          justify-content: space-between;
        }

        .container {
          padding: 1rem;
        }

        .filters-bar {
          flex-direction: column;
          align-items: flex-start;
        }

        .filter-group {
          flex-wrap: wrap;
        }

        .cameras-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Django Template Tags Simulation */
      .django-tag {
        display: inline-block;
        background-color: #f1f1f1;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9rem;
        margin: 0 2px;
        color: #d32f2f;
      }

.modal {
  display: none; /* hide initially */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background: #fff;
  padding: 20px;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
}
.modal img, .modal video {
  width: 100%;
  margin-bottom: 15px;
}



.modal img, .modal video {
  max-width: 90%;
  max-height: 90%;
  margin: auto;
  display: block;
}
.close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 30px;
  cursor: pointer;
}


    </style>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
  </head>
  <body>
    <!-- Django Template Tag for CSRF Token -->
    <!-- {% csrf_token %} -->

    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="logo">
        <i class="fas fa-shield-alt logo-icon"></i>
        <h1>Dump Surveillance AI - Authority Portal</h1>
      </div>

      <div class="nav-links">
        <div class="authority-badge">
          <i class="fas fa-user-shield"></i>
          <!-- Django Template Tag for Username -->
          <!-- {% if user.is_authenticated %} -->
          <span>Authority User: <strong>CityAdmin</strong></span>
          <!-- {% endif %} -->
        </div>

        <a href="#"><i class="fas fa-info-circle"></i> About</a>
        <a href="{% url 'auth_logout' %}" class="sign-out"
          ><i class="fas fa-sign-out-alt"></i> Sign Out</a
        >
      </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <div class="authority-welcome">
          <h2>Authority Control Dashboard</h2>
          <p>
            Monitor illegal dumping activities, manage reports, and update legal
            dumping locations.
          </p>
          <p>
            <strong>Last updated:</strong> Today, 10:45 AM |
            <strong>Active cameras:</strong> 12/15
          </p>
        </div>

        <div class="stats-card">
          <div class="number">48</div>
          <div class="label">Pending Reports</div>
        </div>

        <div class="stats-card">
          <div class="number">127</div>
          <div class="label">Total This Month</div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Offences Reports Card -->
        <div class="card">
          <div class="card-header">
            <h3>
              <i class="fas fa-clipboard-list card-icon"></i> CCTV detected
              reports
            </h3>
            <span class="status-badge status-pending">12 New Today</span>
          </div>

          <!-- Filters and Sorting -->
          <div class="filters-bar">
            <div class="filter-group">
              <select id="sort-by">
                <option value="recent">Sort by: Most Recent</option>
                <option value="oldest">Sort by: Oldest First</option>
                <option value="location">Sort by: Location</option>
              </select>

              <input type="date" id="date-filter" value="2023-10-15" />

              
            </div>

            <button class="btn btn-secondary">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>

          <!-- Offences Table -->
          <div class="offences-container">
            <table class="offences-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date & Time</th>
                  <th>Location</th>
                  <th>Evidence</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody>
{% for event in cctv_events %}
<tr data-timestamp="{{ event.timestamp|date:'Y-m-d H:i:s' }}" data-location="{{ event.illegal_location|default:'Unknown location' }}">
  <td>{{ forloop.counter }}</td>
  <td>{{ event.timestamp|date:"Y-m-d H:i" }}</td>
  <td>{{ event.illegal_location|default:"Unknown location" }}</td>
  <td>
    <div class="action-buttons">
      <button class="btn btn-small" onclick="viewCCTVEvent('{{ event.id }}')">
        <i class="fas fa-eye"></i> View
      </button>
      
    </div>
  </td>
  <td>
    <a class="btn btn-secondary btn-small" href="{{ event.dumping_video.url }}" download>
        <i class="fas fa-download"></i> Download
      </a>
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="5" style="text-align:center;">No CCTV detected events yet</td>
</tr>
{% endfor %}


</tbody>

            </table>
          </div>

          <!-- Download Options -->
          <div class="download-options">
            <button class="btn btn-secondary" onclick="downloadDailyReport()">
              <i class="fas fa-calendar-day"></i> Download Today's Reports
            </button>
            <button class="btn" onclick="downloadAllReports()">
              <i class="fas fa-download"></i> Download All Filtered Reports
            </button>
          </div>
        </div>
        <!-- User Reported Dumping Events -->
        <div class="card">
          <div class="card-header">
            <h3>
              <i class="fas fa-user card-icon"></i> User Reported Dumping Events
            </h3>
            <span class="status-badge status-pending">Citizen Reports</span>
          </div>

          <p>
            Dumping incidents reported directly by citizens using mobile phones.
          </p>

          <div class="offences-container">
            <table class="offences-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Reported At</th>
      <th>Location</th>
      <th>Media</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for report in reports %}
      <tr>
        <td>#USR-{{ report.id }}</td>
        <td>{{ report.created_at|date:"Y-m-d H:i" }}</td>
        <td>{{ report.location }}</td>

        <!-- Media column -->
        <td>
          {% if report.evidences.all %}
            {% for ev in report.evidences.all %}
              <a href="{{ ev.file.url }}" target="_blank">
                <img src="{{ ev.file.url }}" width="50" style="margin-right:5px; border:1px solid #ccc;"/>
              </a>
            {% endfor %}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        <!-- Actions column -->
        <td>
          <a class="btn btn-secondary btn-small"
             href="{% url 'download_report_zip' report.id %}">
            ‚¨áÔ∏è Download ZIP
          </a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

          </div>

        


       

        <!-- Live Cameras Card -->
        <div class="card">
          <div class="card-header">
            <h3><i class="fas fa-video card-icon"></i> Live Camera Feeds</h3>
            <div class="camera-status">
              <span class="status-indicator status-active"></span>
              <span>12 Active</span>
            </div>
          </div>

          <p>
            Monitor live feeds from surveillance cameras in high-risk areas:
          </p>

          <div class="cameras-grid">
            <div class="camera-card">
              <img
                src="/camera/live/05/"
                class="camera-feed"
                alt="Live CCTV Feed"
              />
            </div>
            <div class="camera-info">
              
              <div>
                <strong>Camera #05</strong><br />
                <small>Location - MG Road, Kochi</small>
              </div>
              <div class="status-indicator status-active"></div>
            </div>
          </div>

          <div class="camera-card">
            <div
              class="camera-feed"
              style="
                background-color: #555;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
              "
            >
              <div style="text-align: center">
                <i
                  class="fas fa-video"
                  style="font-size: 2rem; margin-bottom: 0.5rem"
                ></i>
                <p>Live Feed</p>
              </div>
            </div>
            <div class="camera-info">
              <div>
                <strong>Camera #12</strong><br />
                <small>Industrial Zone</small>
              </div>
              <div class="status-indicator status-active"></div>
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem">
          <button class="btn" style="width: 100%">
            <i class="fas fa-expand"></i> View All Camera Feeds (12 Active)
          </button>
        </div>
      </div>
    </div>

    <!-- Second Row -->
    <div class="dashboard-grid">
      <!-- Manage Legal Dumping Locations Card -->

      <div class="card">
        <div class="card-header">
          <h3>
            <i class="fas fa-map-marked-alt card-icon"></i> Legal Dumping
            Locations
          </h3>
          <button id="toggleEditMode" class="btn btn-small">
            <i class="fas fa-plus"></i> Add New Locations
          </button>
        </div>

        <p id="mapInstructions">
          Click on the map to add legal dumping locations. Click on markers to
          edit or delete.
        </p>

        <div class="map-container" style="height: 400px">
          <div
            id="map"
            style="width: 100%; height: 100%; border-radius: 4px"
          ></div>
        </div>

        <div class="map-controls">
          <div style="display: flex; gap: 10px; align-items: center">
            <button id="saveLocationBtn" class="btn" disabled>
              <i class="fas fa-save"></i> Save Location
            </button>
            <button id="cancelLocationBtn" class="btn btn-secondary" disabled>
              <i class="fas fa-times"></i> Cancel
            </button>
            <button id="deleteLocationBtn" class="btn btn-danger" disabled>
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </div>
          <div>
            <span
              id="selectedCoords"
              style="font-size: 0.9rem; color: var(--light-text)"
            ></span>
          </div>
        </div>

        <!-- Location Form (hidden by default) -->
        <div
          id="locationForm"
          style="
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 4px;
          "
        >
          <h4 style="margin-bottom: 1rem">Location Details</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
            <div>
              <label
                for="locationName"
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >Location Name</label
              >
              <input
                type="text"
                id="locationName"
                placeholder="e.g., Downtown Recycling Center"
                style="
                  width: 100%;
                  padding: 0.6rem;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                "
              />
            </div>
            <div>
              <label
                for="locationType"
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >Type</label
              >
              <select
                id="locationType"
                style="
                  width: 100%;
                  padding: 0.6rem;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                "
              >
                <option value="bin">Garbage Bin</option>
                <option value="recycling">Recycling Center</option>
                <option value="transfer">Transfer Station</option>
                <option value="hazardous">Hazardous Waste</option>
              </select>
            </div>
          </div>
          <div style="margin-top: 1rem; display: flex; gap: 1rem">
            <button id="confirmSaveBtn" class="btn">
              <i class="fas fa-check"></i> Confirm Save
            </button>
            <button id="cancelFormBtn" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>

        <div
          style="margin-top: 1rem; font-size: 0.9rem; color: var(--light-text)"
        >
          <p>
            <i class="fas fa-info-circle"></i>
            <span id="locationCount">Loading locations...</span>
          </p>
        </div>
      </div>

      <!-- Recent Illegal Dumps Detected -->
      <div class="card">
        <div class="card-header">
          <h3>
            <i class="fas fa-camera card-icon"></i> Detection analytics
          </h3>
          
          
        </div>

        <p>
          View analytics report of detected dumps
        </p>

        <div class="dumps-grid">
          <!-- Django Template Tag for loop -->
          <!-- {% for dump in recent_dumps %} -->
          <div class="dump-item">
            <img
              src="https://images.unsplash.com/photo-1589652717521-10c0d092dea9?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
              alt="Illegal dump site"
            />
            <div class="dump-info">
              <strong>Downtown Area</strong><br />
              Detected: 2 hours ago<br />
              <small>Confidence: 94%</small>
            </div>
          </div>

          <div class="dump-item">
            <img
              src="https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
              alt="Illegal dump site"
            />
            <div class="dump-info">
              <strong>Industrial Zone</strong><br />
              Detected: 5 hours ago<br />
              <small>Confidence: 87%</small>
            </div>
          </div>

          <div class="dump-item">
            <img
              src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
              alt="Illegal dump site"
            />
            <div class="dump-info">
              <strong>Riverside</strong><br />
              Detected: 8 hours ago<br />
              <small>Confidence: 92%</small>
            </div>
          </div>

          <div class="dump-item">
            <img
              src="https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60"
              alt="Illegal dump site"
            />
            <div class="dump-info">
              <strong>Forest Road</strong><br />
              Detected: 12 hours ago<br />
              <small>Confidence: 76%</small>
            </div>
          </div>
          <!-- {% endfor %} -->
        </div>

        <a href="{% url 'analytics_dashboard' %}">
          <button class="btn btn-primary">
            View Analytics
          </button>
        </a>

      </div>
    </div>
    <div id="mediaModal" class="modal">
  <span class="close" onclick="closeMediaModal()">&times;</span>
  <div id="modalContent"></div>
</div>

    <!-- Footer -->
    <footer class="footer">
      <p>
        Dump Surveillance AI - Authority Portal &copy; 2026. Restricted access
        for authorized personnel only.
      </p>
      <p>All activities are logged for security and compliance purposes.</p>
    </footer>

    <script>
      let map = L.map("map").setView([10.8505, 76.2711], 7); // Kerala default
      let selectedMarker = null;
      let markers = [];
      let tempMarker = null;
      let selectedLatLng = null;
      let editMode = false;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      map.on("click", function (e) {
        selectedLatLng = e.latlng;

        if (selectedMarker) {
          map.removeLayer(selectedMarker);
        }

        selectedMarker = L.marker(e.latlng).addTo(map);

        document.getElementById(
          "selectedCoords"
        ).innerText = `Lat: ${e.latlng.lat.toFixed(
          6
        )}, Lng: ${e.latlng.lng.toFixed(6)}`;

        document.getElementById("saveLocationBtn").disabled = false;
      });
    </script>

    <script>
      document
        .getElementById("saveLocationBtn")
        .addEventListener("click", () => {
          document.getElementById("locationForm").style.display = "block";
        });
    </script>

    <script>
      function loadLocations() {
        fetch("/get-locations/")
          .then((response) => response.json())
          .then((locations) => {
            // Clear existing markers
            markers.forEach((m) => map.removeLayer(m));
            markers = [];

            locations.forEach((loc) => {
              const marker = L.marker([loc.lat, loc.lng]).addTo(map);
              marker.locationId = loc.id;

              marker.on("click", () => {
                selectedMarker = marker;
                document.getElementById("deleteLocationBtn").disabled = false;
              });
              marker.bindPopup(`
                    <b>${loc.name}</b><br>
                    Type: ${loc.type}<br>
                    Lat: ${loc.lat.toFixed(5)}<br>
                    Lng: ${loc.lng.toFixed(5)}
                `);

              markers.push(marker);
            });

            document.getElementById(
              "locationCount"
            ).innerText = `${locations.length} legal dumping locations loaded`;
          })
          .catch((err) => console.error("Error loading locations:", err));
      }

      // Load markers when page opens
      loadLocations();
    </script>

    <script>
      document
        .getElementById("deleteLocationBtn")
        .addEventListener("click", () => {
          console.log("‚ùå Delete button clicked");

          if (!selectedMarker || !selectedMarker.locationId) {
            alert("Please select a location marker to delete");
            return;
          }

          console.log("üìç Location ID:", selectedMarker.locationId);

          if (!confirm("Are you sure you want to delete this location?")) {
            return;
          }

          fetch("/delete-location/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              id: selectedMarker.locationId,
            }),
          })
            .then((res) => {
              console.log("üì° Response received", res);
              return res.json();
            })
            .then((data) => {
              console.log("‚úÖ Server response:", data);
            })
            .catch((err) => console.error("üî• Fetch error:", err));
        });
    </script>

    <script>
      document
        .getElementById("confirmSaveBtn")
        .addEventListener("click", () => {
          const name = document.getElementById("locationName").value;
          const type = document.getElementById("locationType").value;

          if (!name || !selectedLatLng) {
            alert("Please select location and enter name");
            return;
          }

          fetch("/save-location/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              name: name,
              type: type,
              lat: selectedLatLng.lat,
              lng: selectedLatLng.lng,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              alert("Location saved successfully!");
              document.getElementById("locationForm").style.display = "none";
              document.getElementById("locationName").value = "";
            })
            .catch((err) => console.error(err));
        });
    </script>

    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>

    <script>
      // JavaScript for interactive elements

      // Sort offences table
      const sortSelect = document.getElementById("sort-by");
      const dateFilter = document.getElementById("date-filter");
      const statusFilter = document.getElementById("status-filter");

      sortSelect.addEventListener("change", function () {
        console.log("Sorting by:", this.value);
        // In a real app, this would trigger an API call or page refresh
        // with the new sorting parameter
      });

      dateFilter.addEventListener("change", function () {
        console.log("Filtering by date:", this.value);
        // In a real app, this would filter the offences table
      });

      statusFilter.addEventListener("change", function () {
        console.log("Filtering by status:", this.value);
        // In a real app, this would filter the offences table
      });

      // Download functions
      function downloadReport(reportId) {
        alert(`Downloading report ${reportId}...`);
        // In a real app, this would trigger a file download
        // Example: window.location.href = `/download-report/${reportId}/`;
      }

      function downloadDailyReport() {
        const today = new Date().toISOString().split("T")[0];
        alert(`Downloading all reports for ${today}...`);
        // In a real app, this would trigger a bulk download
        // Example: window.location.href = `/download-daily-reports/?date=${today}`;
      }

      function downloadAllReports() {
        const sortBy = sortSelect.value;
        const date = dateFilter.value;
        const status = statusFilter.value;

        alert(
          `Downloading all filtered reports (Sort: ${sortBy}, Date: ${date}, Status: ${status})...`
        );
        // In a real app, this would trigger a bulk download with filters
      }

      function viewOffenceDetails(offenceId) {
        alert(`Viewing details for offence ${offenceId}`);
        // In a real app, this would open a modal or redirect to a detail page
        // Example: window.location.href = `/offence/${offenceId}/`;
      }

      // Toggle camera status
      const cameraCards = document.querySelectorAll(".camera-card");
      cameraCards.forEach((card) => {
        card.addEventListener("click", function (e) {
          if (!e.target.closest(".camera-info")) {
            const statusIndicator = this.querySelector(".status-indicator");
            const isActive =
              statusIndicator.classList.contains("status-active");

            if (isActive) {
              statusIndicator.classList.remove("status-active");
              statusIndicator.classList.add("status-inactive");
              this.querySelector(".camera-info strong").innerHTML +=
                " (OFFLINE)";
            } else {
              statusIndicator.classList.remove("status-inactive");
              statusIndicator.classList.add("status-active");
              const strongText = this.querySelector(
                ".camera-info strong"
              ).textContent;
              this.querySelector(".camera-info strong").textContent =
                strongText.replace(" (OFFLINE)", "");
            }
          }
        });
      });

      // Initialize the map when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
        loadLegalLocations();
        setupEventListeners();
      });

      function setupEventListeners() {
        // Toggle edit mode
        document
          .getElementById("toggleEditMode")
          .addEventListener("click", function () {
            editMode = !editMode;
            if (editMode) {
              this.innerHTML = '<i class="fas fa-times"></i> Exit Edit Mode';
              this.classList.add("btn-danger");
              document.getElementById("mapInstructions").innerHTML =
                "Click on the map to add a new legal dumping location.";
              document.getElementById("mapInstructions").style.color =
                "var(--secondary-dark)";
              document.getElementById("mapInstructions").style.fontWeight =
                "bold";
            } else {
              this.innerHTML = '<i class="fas fa-plus"></i> Add New Locations';
              this.classList.remove("btn-danger");
              document.getElementById("mapInstructions").innerHTML =
                "Click on markers to edit or delete. Switch to edit mode to add new locations.";
              document.getElementById("mapInstructions").style.color = "";
              document.getElementById("mapInstructions").style.fontWeight =
                "normal";
              clearSelection();
            }
          });
      }

      // Save location button
      document
        .getElementById("saveLocationBtn")
        .addEventListener("click", function () {
          if (currentLatLng) {
            showLocationForm();
          }
        });

      // Cancel location button
      document
        .getElementById("cancelLocationBtn")
        .addEventListener("click", function () {
          clearSelection();
        });

      // Delete location button
      document
        .getElementById("deleteLocationBtn")
        .addEventListener("click", function () {
          clearSelection();
        });

      // Confirm save from form
      document
        .getElementById("confirmSaveBtn")
        .addEventListener("click", function () {
          saveLocation();
        });

      function handleMapClick(e) {
        // Clear previous temp marker
        if (tempMarker) {
          map.removeLayer(tempMarker);
        }

        // Add new temporary marker
        tempMarker = L.marker(e.latlng, {
          draggable: true,
          icon: L.icon({
            iconUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
            shadowUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
          }),
        }).addTo(map);

        // Update coordinates display
        currentLatLng = e.latlng;
        document.getElementById(
          "selectedCoords"
        ).innerHTML = `Selected: Lat ${e.latlng.lat.toFixed(
          6
        )}, Lng ${e.latlng.lng.toFixed(6)}`;

        // Enable save button
        document.getElementById("saveLocationBtn").disabled = false;
        document.getElementById("cancelLocationBtn").disabled = false;

        // Make marker draggable
        tempMarker.on("dragend", function (event) {
          const marker = event.target;
          const position = marker.getLatLng();
          currentLatLng = position;
          document.getElementById(
            "selectedCoords"
          ).innerHTML = `Selected: Lat ${position.lat.toFixed(
            6
          )}, Lng ${position.lng.toFixed(6)}`;
        });
      }

      function showLocationForm() {
        document.getElementById("locationForm").style.display = "block";
        document.getElementById("saveLocationBtn").disabled = true;
        document.getElementById("cancelLocationBtn").disabled = true;
      }

      function hideLocationForm() {
        document.getElementById("locationForm").style.display = "none";
        document.getElementById("locationName").value = "";
        document.getElementById("locationType").value = "bin";
      }

      function clearSelection() {
        // Remove temp marker
        if (tempMarker) {
          map.removeLayer(tempMarker);
          tempMarker = null;
        }

        // Clear selection
        currentLatLng = null;
        selectedMarker = null;

        // Reset UI
        document.getElementById("selectedCoords").innerHTML = "";
        document.getElementById("saveLocationBtn").disabled = true;
        document.getElementById("cancelLocationBtn").disabled = true;
        document.getElementById("deleteLocationBtn").disabled = true;
        hideLocationForm();

        // Reset markers to default style
        markers.forEach((marker) => {
          marker.setIcon(
            L.icon({
              iconUrl:
                "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
              shadowUrl:
                "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
            })
          );
        });
      }

      function getMarkerIcon(type) {
        // Custom icons based on location type
        const iconUrl =
          {
            bin: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
            recycling:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
            transfer:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",
            hazardous:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
          }[type] ||
          "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png";

        return L.icon({
          iconUrl: iconUrl,
          shadowUrl:
            "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
        });
      }

      function getLocationTypeText(type) {
        const types = {
          bin: "Garbage Bin",
          recycling: "Recycling Center",
          transfer: "Transfer Station",
          hazardous: "Hazardous Waste",
        };
        return types[type] || "Unknown";
      }

      function selectMarker(marker) {
        // Clear previous selection
        clearSelection();

        // Set as selected marker
        selectedMarker = marker;

        // Highlight the marker
        marker.setIcon(
          L.icon({
            iconUrl:
              "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
            shadowUrl:
              "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
          })
        );

        // Show coordinates
        const latLng = marker.getLatLng();
        document.getElementById("selectedCoords").innerHTML = `Selected: ${
          marker.locationData.name
        } (Lat ${latLng.lat.toFixed(6)}, Lng ${latLng.lng.toFixed(6)})`;

        // Enable delete button
        document.getElementById("deleteLocationBtn").disabled = false;
        document.getElementById("cancelLocationBtn").disabled = false;

        // Open popup
        marker.openPopup();
      }

      function getCSRFToken() {
        // Get CSRF token from cookie or meta tag
        let csrfToken = null;
        const cookieValue = document.cookie.match(
          "(^|;)\\s*csrftoken\\s*=\\s*([^;]+)"
        );
        if (cookieValue) {
          csrfToken = cookieValue.pop();
        } else {
          const metaTag = document.querySelector('meta[name="csrf-token"]');
          if (metaTag) {
            csrfToken = metaTag.getAttribute("content");
          }
        }
        return csrfToken;
      }

      // Add to your existing simulateCameraUpdates function if needed
      // You can keep your existing JavaScript functions
      // Simulate live camera updates
      function simulateCameraUpdates() {
        // Randomly toggle a camera status every 30 seconds
        setTimeout(() => {
          const randomIndex = Math.floor(Math.random() * cameraCards.length);
          const randomCard = cameraCards[randomIndex];
          const statusIndicator = randomCard.querySelector(".status-indicator");
          const isActive = statusIndicator.classList.contains("status-active");

          if (isActive) {
            statusIndicator.classList.remove("status-active");
            statusIndicator.classList.add("status-inactive");
            randomCard.querySelector(".camera-info strong").innerHTML +=
              " (OFFLINE)";
          } else {
            statusIndicator.classList.remove("status-inactive");
            statusIndicator.classList.add("status-active");
            const strongText = randomCard.querySelector(
              ".camera-info strong"
            ).textContent;
            randomCard.querySelector(".camera-info strong").textContent =
              strongText.replace(" (OFFLINE)", "");
          }

          simulateCameraUpdates();
        }, 30000);
      }

      // Start camera updates simulation
      simulateCameraUpdates();

      // Map interaction simulation
      const mapContainer = document.querySelector(".map-container");
      function loadUserReports() {
  fetch("/authority/user-reports/")
    .then(res => res.json())
    .then(reports => {
      const tbody = document.getElementById("userReportsTable");
      tbody.innerHTML = "";

      reports.forEach(r => {
        const mediaIcons = r.media.length
          ? r.media.map(url =>
              `<img src="${url}" width="40"
                style="cursor:pointer;margin-right:5px"
                onclick="openMedia('${url}')">`
            ).join("")
          : "‚Äî";
        tbody.innerHTML += `
  <tr>
    <td>#USR-${r.id}</td>
    <td>${r.reported_at}</td>
    <td>${r.location}</td>
    <td>${mediaIcons}</td>
    
    <td>
      <button class="btn btn-small" onclick="viewUserReport(${r.id})">
        <i class="fas fa-eye"></i> View
      </button>

      <a class="btn btn-secondary btn-small"
         href="/authority/user-reports/${r.id}/download/">
        <i class="fas fa-download"></i> ZIP
      </a>
    </td>
  </tr>
`;

      });
    })
    .catch(err => console.error("User reports load error:", err));
}

document.addEventListener("DOMContentLoaded", loadUserReports);

  




function openMedia(url) {
  const modal = document.getElementById("mediaModal");
  const container = document.getElementById("modalContent");

  container.innerHTML = "";

  if (url.match(/\.(mp4|webm|ogg)$/i)) {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.autoplay = true;
    container.appendChild(video);
  } else {
    const img = document.createElement("img");
    img.src = url;
    container.appendChild(img);
  }

  modal.style.display = "flex";
}


    





function viewUserReport(reportId) {
  fetch(`/authority/user-report/${reportId}/media/`)
    .then(res => res.json())
    .then(data => {
      console.log("MEDIA RESPONSE:", data);

      const container = document.getElementById("modalContent");
      container.innerHTML = "";

      if (!data.files || data.files.length === 0) {
        container.innerHTML = "<p>No evidence uploaded.</p>";
      }

      data.files.forEach(f => {
        if (f.type === "image") {
          const img = document.createElement("img");
          img.src = f.url;
          container.appendChild(img);
        } else {
          const video = document.createElement("video");
          video.controls = true;
          video.src = f.url;
          container.appendChild(video);
        }
      });

      document.getElementById("mediaModal").style.display = "flex";
    })
    .catch(err => {
      console.error(err);
      alert("Failed to load evidence");
    });
}

function closeMediaModal() {
  const modal = document.getElementById("mediaModal");
  const content = document.getElementById("modalContent");

  modal.style.display = "none";
  content.innerHTML = "";
}

       fetch("/authority/cctv-events/")
  .then(res => res.json())
  .then(events => {
    const grid = document.getElementById("cctvGrid");
    grid.innerHTML = "";

    events.forEach(ev => {
      const plateImg = ev.plate_image
        ? `/media/${ev.plate_image}`
        : "/static/no-plate.png";

      const confidence = ev.confidence
        ? (ev.confidence * 100).toFixed(1) + "%"
        : "N/A";

      grid.innerHTML += `
        <div class="dump-item">
          <img src="${plateImg}" alt="Detected Vehicle">

          <div class="dump-info">
            <strong>${ev.location}</strong><br>
            Camera: ${ev.camera_id}<br>
            Time: ${ev.timestamp}<br>
            Plate Confidence: ${confidence}
          </div>
        </div>
      `;
    });
  })
  .catch(err => console.error("CCTV load error:", err));
  

function viewCCTVEvent(eventId) {
  fetch(`/authority/cctv-event/${eventId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("modalContent");
      container.innerHTML = "";

      const video = document.createElement("video");
      video.src = data.video_url;
      video.controls = true;
      video.autoplay = true;

      container.appendChild(video);
      document.getElementById("mediaModal").style.display = "flex";
    });
}

const tableBody = document.querySelector(".offences-table tbody");

function sortAndFilterTable() {
  const sortBy = sortSelect.value;
  const selectedDate = dateFilter.value;
  const status = statusFilter.value;

  // Get all rows as array
  let rows = Array.from(tableBody.querySelectorAll("tr"));

  // Remove empty row if exists
  rows = rows.filter(row => !row.classList.contains('empty-row'));

  // Filter by date
  if (selectedDate) {
    rows = rows.filter(row => {
      const rowDate = row.dataset.timestamp.split(" ")[0]; // 'YYYY-MM-DD'
      return rowDate === selectedDate;
    });
  }

  // Filter by status
  if (status !== "all") {
    rows = rows.filter(row => row.dataset.status === status);
  }

  // Sort
  if (sortBy === "recent") {
    rows.sort((a, b) => new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp));
  } else if (sortBy === "oldest") {
    rows.sort((a, b) => new Date(a.dataset.timestamp) - new Date(b.dataset.timestamp));
  } else if (sortBy === "location") {
    rows.sort((a, b) => a.dataset.location.localeCompare(b.dataset.location));
  }

  // Re-append rows
  tableBody.innerHTML = "";
  if (rows.length === 0) {
    tableBody.innerHTML = `<tr class="empty-row"><td colspan="6" style="text-align:center;">No CCTV detected events yet</td></tr>`;
  } else {
    rows.forEach(r => tableBody.appendChild(r));
  }
}

// Add event listeners
sortSelect.addEventListener("change", sortAndFilterTable);
dateFilter.addEventListener("change", sortAndFilterTable);
statusFilter.addEventListener("change", sortAndFilterTable);

// Initial sort
sortAndFilterTable();



    </script>



  </body>
</html>
